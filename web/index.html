<!DOCTYPE html>
<html>
<head>
    <title> Tic Tac Toe </title>
    <style type="text/css">
        html {
            height: 100%;
            min-height: 100%;
        }
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 100%;
        }
        table {
            width: 40%;
            border-collapse: collapse;
        }
        td {
            width: 33%;
            height: 33%;
            background-color: #f0f0f0;
            border: 6px solid #222;
            cursor: pointer;
        }
        td:after {
            content: "";
            display: block;
            margin-top: 100%;
        }
        td:first-of-type {
            border-left-color: transparent;
            border-top-color: transparent;
        }
        td:nth-of-type(2) {
            border-top-color: transparent;
        }
        td:nth-of-type(3) {
            border-right-color: transparent;
            border-top-color: transparent;
        }
        tr:nth-of-type(3) td {
            border-bottom-color: transparent;
        }

        .end td, td.o, td.x {
            cursor: default;
        }

        td.x {
            background-color: #cc3333;
        }
        td.x::before {
            content: "X";
            position: absolute;
            color: #ccc;
        }
        td.o {
            background-color: #3333cc;
        }
        td.o::before {
            content: "O";
            position: absolute;
            color: #ccc;
        }

    </style>
</head>
<body onload="init();">
    <table id="board">
        <tbody>
            <tr>
                <td data-index="1" onclick="c(this);"></td>
                <td data-index="2" onclick="c(this);"></td>
                <td data-index="3" onclick="c(this);"></td>
            </tr>
            <tr>
                <td data-index="4" onclick="c(this);"></td>
                <td data-index="5" onclick="c(this);"></td>
                <td data-index="6" onclick="c(this);"></td>
            </tr>
            <tr>
                <td data-index="7" onclick="c(this);"></td>
                <td data-index="8" onclick="c(this);"></td>
                <td data-index="9" onclick="c(this);"></td>
            </tr>
        </tbody>
    </table>
    <script type="text/javascript">

        let board = document.getElementById("board");
        let current_player = false;
        let player_start = true;
        let win_conditions = [[1,2,3],
                              [4,5,6],
                              [7,8,9],
                              [1,4,7],
                              [2,5,8],
                              [3,6,9],
                              [1,5,9],
                              [3,5,7]];
        let drawable = [];
        let plays = {
            player: [],
            cpu: []
        }

        function init() {
            for(let i = 0; ++i < 10;)
                drawable.push(" ");

            if(!player_start) {
                play(plays, drawable, win_conditions);
            }
        }

        function c(e) {
            if(e.className == "" && board.className != "end") {
                e.className = player_start ? "x" : "o";
                drawable[e.dataset.index-1] = e.className;
                plays.player.push(~~e.dataset.index);
                play(plays, drawable, win_conditions);
            }
        }

        function play(plays, drawable, win_conditions) {
            let move = podevencer();
            if(plays.player.indexOf(move) == -1 && plays.cpu.indexOf(move) == -1 && move > 0 && move < 10) {
                plays.cpu.push(move);
                drawable[move-1] = player_start ? "o" : "x";
                updateBoard(drawable);
            } else {
                move = naodeixevencer();
                if(plays.player.indexOf(move) == -1 && plays.cpu.indexOf(move) == -1 && move > 0 && move < 10) {
                    plays.cpu.push(move);
                    drawable[move-1] = player_start ? "o" : "x";
                    updateBoard(drawable);
                } else if(
                (plays.player[0] == 1 && plays.player[1] == 9)
                ||
                (plays.player[0] == 9 && plays.player[1] == 1)
                ||
                (plays.player[0] == 3 && plays.player[1] == 7)
                ||
                (plays.player[0] == 7 && plays.player[1] == 3)) {
                    plays.cpu.push(4);
                    drawable[3] = player_start ? "o" : "x";
                    updateBoard(drawable);
                } else {
                    if(plays.player.indexOf(5) == -1
                    && plays.cpu.indexOf(5) == -1) {
                        plays.cpu.push(5);
                        drawable[4] = player_start ? "o" : "x";
                        updateBoard(drawable);
                    } else {
                        if(
                        (plays.player[0] == 1 && plays.player[1] == 8)
                        ||
                        (plays.player[0] == 8 && plays.player[1] == 1)) {
                            plays.cpu.push(7);
                            drawable[6] = player_start ? "o" : "x";
                            updateBoard(drawable);
                        } else if(
                        (plays.player[0] == 3 && plays.player[1] == 8)
                        ||
                        (plays.player[0] == 8 && plays.player[1] == 3)) {
                            plays.cpu.push(9);
                            drawable[8] = player_start ? "o" : "x";
                            updateBoard(drawable);
                        } else {
                            let ponta = [1,3,7,9];
                            let repete = false;
                            for(let i = 0, l = ponta.length; i < l; i++) {
                                if(plays.player.indexOf(ponta[i]) == -1
                                && plays.cpu.indexOf(ponta[i]) == -1
                                && !repete) {
                                    repete = true;
                                    plays.cpu.push(ponta[i]);
                                    drawable[ponta[i]-1] = player_start ? "o" : "x";
                                    updateBoard(drawable);
                                    break;
                                }
                            }
                            if(!repete) {
                                let meio = [2,4,6,8];
                                for(let i = 0, l = meio.length; i < l; i++) {
                                    if(plays.player.indexOf(meio[i])== -1
                                    && plays.cpu.indexOf(meio[i]) == -1) {
                                        plays.cpu.push(meio[i]);
                                        drawable[meio[i]-1] = player_start ? "o" : "x";
                                        updateBoard(drawable);
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            if(isGameOver(plays)) {
                let is_draw = true;
                for(let i = 0, l = win_conditions.length; i < l; i++) {
                    if(plays.cpu.indexOf(win_conditions[i][0])>-1
                    && plays.cpu.indexOf(win_conditions[i][1])>-1
                    && plays.cpu.indexOf(win_conditions[i][2])>-1) {
                        console.log("CPU venceu");
                        is_draw = false;
                        break;
                    } else if(plays.cpu.indexOf(win_conditions[i][0])>-1
                        && plays.cpu.indexOf(win_conditions[i][1]>-1)
                        && plays.cpu.indexOf(win_conditions[i][2])>-1) {
                        console.log("Jogador venceu");
                        is_draw = false;
                        break;
                    }
                }
                if(is_draw) console.log("Deu velha.");
            }
        }

        function isGameOver(plays) {
            if(!plays.player.length || !plays.cpu.length) return false;
            for(let i = 0, l = win_conditions.length; i < l; i++) {
                if((plays.player.indexOf(win_conditions[i][0]) > -1
                && plays.player.indexOf(win_conditions[i][1]) > -1
                && plays.player.indexOf(win_conditions[i][2]) > -1)
                ||(plays.cpu.indexOf(win_conditions[i][0]) > -1
                && plays.cpu.indexOf(win_conditions[i][1]) > -1
                && plays.cpu.indexOf(win_conditions[i][2]) > -1)
                ||(plays.player.length + plays.cpu.length >= 9)) {
                    board.className = "end";
                    return (game_over = true);
                }
            }
            return false;
        }

        function updateBoard(desenha) {
            for(let i = 0; i < 9; i++) {
                if(desenha[i] != " ") {
                    let e = document.querySelector("[data-index='" + (i+1) + "']");
                    if(e.className != desenha[i])
                        e.className = desenha[i];
                }
            }
        }

        function podevencer() {
            for(let i = 0, l = win_conditions.length; i < l; i++) {
                if(plays.cpu.indexOf(win_conditions[i][0]) > -1
                && plays.cpu.indexOf(win_conditions[i][1]) > -1
                && plays.cpu.indexOf(win_conditions[i][2]) == -1
                && plays.player.indexOf(win_conditions[i][2]) == -1) {
                    return win_conditions[i][2];
                } else if(plays.cpu.indexOf(win_conditions[i][0]) > -1
                && plays.cpu.indexOf(win_conditions[i][2]) > -1
                && plays.cpu.indexOf(win_conditions[i][1]) == -1
                && plays.player.indexOf(win_conditions[i][1]) == -1) {
                    return win_conditions[i][1];
                } else if(plays.cpu.indexOf(win_conditions[i][1]) > -1
                && plays.cpu.indexOf(win_conditions[i][2]) > -1
                && plays.cpu.indexOf(win_conditions[i][0]) == -1
                && plays.player.indexOf(win_conditions[i][0]) == -1) {
                    return win_conditions[i][0];
                }
            }
            return 10;
        }

        function naodeixevencer() { // n => plays.player
            for(let i = 0, l = win_conditions.length; i < l; i++) {
                if (plays.player.indexOf(win_conditions[i][0]) > -1
                && plays.player.indexOf(win_conditions[i][1]) > -1
                && plays.player.indexOf(win_conditions[i][2]) == -1
                && plays.cpu.indexOf(win_conditions[i][2]) == -1) {
                    return win_conditions[i][2];
                } else if(plays.player.indexOf(win_conditions[i][0]) > -1
                && plays.player.indexOf(win_conditions[i][2]) > -1
                && plays.player.indexOf(win_conditions[i][1]) == -1
                && plays.cpu.indexOf(win_conditions[i][1]) == -1) {
                    return win_conditions[i][1];
                } else if(plays.player.indexOf(win_conditions[i][1]) > -1
                && plays.player.indexOf(win_conditions[i][2]) > -1
                && plays.player.indexOf(win_conditions[i][0]) == -1
                && plays.cpu.indexOf(win_conditions[i][0]) == -1) {
                    return win_conditions[i][0];
                }
            }
            return 10;
        }
    </script>
</body>
</html>